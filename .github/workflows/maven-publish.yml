name: Maven Package

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write          # needed to push commit
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0       # important for tags/branches
          persist-credentials: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Configure git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set release version from tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"  # strips leading "v" if present
          echo "Release tag: $TAG -> version: $VERSION"

          mvn -B versions:set -DnewVersion="$VERSION" -DgenerateBackupPoms=false
          mvn -B versions:commit

          # Commit release version change (optional but common)
          git add pom.xml **/pom.xml || true
          git commit -m "Release $VERSION" || echo "No changes to commit"

      - name: Build + Deploy
        run: |
          mvn -B deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Bump to next snapshot and push to main
        run: |
          # Switch to default branch (release workflows check out the tag commit)
          git fetch origin main
          git checkout main
          git pull --ff-only origin main

          # Decide next version. Simplest: bump patch.
          # e.g. 1.2.3 -> 1.2.4-SNAPSHOT
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEXT_PATCH=$((PATCH + 1))
          NEXT="${MAJOR}.${MINOR}.${NEXT_PATCH}-SNAPSHOT"
          echo "Next snapshot: $NEXT"

          mvn -B versions:set -DnewVersion="$NEXT" -DgenerateBackupPoms=false
          mvn -B versions:commit

          git add pom.xml **/pom.xml || true
          git commit -m "Bump version to $NEXT" || echo "No changes to commit"

          git push origin main
